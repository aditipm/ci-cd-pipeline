- pipeline: "buddy-ci"
  on: "EVENT"
  events:
  - type: "PUSH"
    refs:
    - "refs/heads/master"
  priority: "NORMAL"
  auto_clear_cache: true
  fail_on_prepare_env_warning: true
  actions:
  - action: "Build Docker image"
    type: "DOCKERFILE"
    dockerfile_path: "Dockerfile"
    buildkit: true
    target_platform: "linux/amd64"
  - action: "Kubernetes - deployment apply"
    type: "KUBERNETES_APPLY"
    auth_type: "TOKEN"
    server: ${{ secrets.BUDDY_K8S_SERVER }} 
    config_path: "k8s-deployment.yaml"
    kubectl_version: "latest"
    validate: true
    record_arg: "NOT_SET"
    overwrite_arg: true
    cascade: "BACKGROUND"
    grace_period_arg: 30
    token: ${{ secrets.K8S_TOKEN }}
  - action: "Send notification to devops channel"
    type: "SLACK"
    content: "[#$BUDDY_EXECUTION_ID] $BUDDY_PIPELINE_NAME execution by <$BUDDY_INVOKER_URL|$BUDDY_INVOKER_NAME>"
    blocks: "[{\"type\":\"section\",\"fields\":[{\"type\":\"mrkdwn\",\"text\":\"*Successful execution:* <$BUDDY_EXECUTION_URL|Execution #$BUDDY_EXECUTION_ID $BUDDY_EXECUTION_COMMENT>\"},{\"type\":\"mrkdwn\",\"text\":\"*Pipeline:* <$BUDDY_PIPELINE_URL|$BUDDY_PIPELINE_NAME>\"},{\"type\":\"mrkdwn\",\"text\":\"*Branch:* $BUDDY_EXECUTION_BRANCH\"},{\"type\":\"mrkdwn\",\"text\":\"*Project:* <$BUDDY_PROJECT_URL|$BUDDY_PROJECT_NAME>\"}]}]"
    channel: ${{ secrets.SLACK_CHANNEL }}
    channel_name: "devops"
    integration_hash: ${{ secrets.BUDDY_HASH }}
  - action: "Sleep 15 seconds"
    type: "SLEEP"
    trigger_time: "ON_FAILURE"
    sleep_in_sec: 15
